<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Gallery Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap');

        body {
            font-family: 'Noto+Sans+JP', sans-serif;
            background-color: #f8fafc;
        }

        .gallery-item:hover .overlay {
            opacity: 1;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #main-content {
            display: none;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #020617 0%, #1e1b4b 100%);
        }
    </style>
</head>

<body class="min-h-screen text-slate-800">

    <!-- Auth Overlay (Login Screen) -->
    <div id="auth-overlay" class="fixed inset-0 bg-slate-50 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-3xl shadow-xl max-w-sm w-full text-center border border-slate-200">
            <div class="text-5xl mb-6">ğŸ“¸</div>
            <h2 class="text-2xl font-bold mb-2 text-slate-800">Photo Share</h2>
            <p class="text-slate-500 text-sm mb-8 leading-relaxed">
                å…±æœ‰ã•ã‚ŒãŸå†™çœŸã‚’é–²è¦§ã™ã‚‹ã«ã¯<br>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </p>
            <button id="login-button"
                class="flex items-center justify-center gap-3 w-full bg-white border border-slate-300 text-slate-700 py-3 rounded-xl font-medium hover:bg-slate-50 transition-all shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="18" height="18"
                    alt="Google">
                Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è©³ç´°åŒ– -->
            <div id="auth-error-container" class="mt-6 text-left hidden">
                <p class="text-red-500 text-xs font-bold mb-1">âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼</p>
                <p id="auth-error-text" class="text-slate-600 text-[10px] leading-relaxed"></p>
                <div id="unauthorized-domain-guide"
                    class="hidden mt-2 p-2 bg-amber-50 rounded border border-amber-100 text-[10px] text-amber-800">
                    <p class="font-bold">ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è¿½åŠ ãŒå¿…è¦ã§ã™ï¼š</p>
                    <p>Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã® [Authentication] > [è¨­å®š] > [æ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³] ã«ã€ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content (Authorized only) -->
    <div id="main-content">
        <!-- Hero Section -->
        <header class="gradient-bg text-white py-16 px-6 text-center">
            <div class="max-w-5xl mx-auto">
                <div
                    class="inline-block px-4 py-1 border border-blue-400 rounded-full text-blue-300 text-sm mb-4 tracking-widest font-bold">
                    Happy Planet Earth Project
                </div>
                <h1 class="text-3xl md:text-5xl font-bold mb-4 leading-tight">
                    Shared Memories<br>
                    <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 text-xl md:text-3xl">ãƒ•ã‚©ãƒˆã‚®ãƒ£ãƒ©ãƒªãƒ¼</span>
                </h1>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="sticky top-0 bg-white/90 backdrop-blur-md shadow-sm z-50">
            <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex flex-col sm:flex-row sm:items-center sm:gap-6">
                    <div class="flex gap-4 mb-1 sm:mb-0">
                        <a href="index.html"
                            class="text-xs font-bold text-slate-600 hover:text-indigo-600 transition-colors">é€šå¸¸ç‰ˆã¸</a>
                        <a href="shuffle.html"
                            class="text-xs font-bold text-slate-600 hover:text-indigo-600 transition-colors">ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç‰ˆã¸</a>
                    </div>
                    <p id="user-role-badge"
                        class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 w-fit"></p>
                </div>

                <div class="flex items-center gap-3">
                    <div id="loading-status" class="hidden">
                        <div class="loader"></div>
                    </div>

                    <div id="admin-actions" class="hidden flex items-center gap-2">
                        <button id="settings-toggle" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors"
                            title="ç®¡ç†è€…è¨­å®š">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path
                                    d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                        </button>
                    </div>

                    <button id="copy-link"
                        class="hidden sm:block bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full text-xs font-medium hover:bg-indigo-100 transition-colors">
                        å…±æœ‰
                    </button>

                    <button id="logout-button" class="text-slate-400 hover:text-red-500 transition-colors"
                        title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto px-4 py-8">
            <div id="settings-panel"
                class="hidden mb-8 bg-white p-6 rounded-2xl shadow-sm border border-indigo-100 ring-1 ring-indigo-50">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span class="text-indigo-600">âš™ï¸</span> ç®¡ç†è€…è¨­å®š
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label
                            class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">Googleãƒ‰ãƒ©ã‚¤ãƒ–
                            ãƒ•ã‚©ãƒ«ãƒ€ID</label>
                        <input type="text" id="folder-id-input"
                            class="w-full px-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">Google
                            Drive APIã‚­ãƒ¼</label>
                        <input type="password" id="api-key-input"
                            class="w-full px-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <button id="sync-button"
                    class="w-full bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">
                    è¨­å®šã‚’ä¿å­˜ã—ã¦å†™çœŸã‚’åŒæœŸ
                </button>
            </div>

            <div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>

            <div id="status-message" class="hidden py-20 text-center">
                <div id="status-icon" class="text-5xl mb-4">âœ¨</div>
                <p id="status-text" class="text-slate-400 font-light">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </main>

        <footer class="bg-slate-950 text-white py-20 px-6 text-center border-t border-white/5">
            <div class="max-w-4xl mx-auto">
                <p class="text-blue-400 font-bold mb-4 uppercase tracking-widest text-xs">Knowledge Blend & Innovative
                    DAO</p>
                <h3 class="text-2xl font-bold mb-6 italic">Creative Trial: 23 Experts Synergy</h3>
                <p class="text-gray-400 mb-8 text-sm leading-relaxed">
                    23åã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã«ã‚ˆã‚‹ã€ŒçŸ¥ã®èåˆã€ãŒã€åœæ»ã—ãŸç¾ä»£ç¤¾ä¼šã«<br class="hidden md:block">çœŸã®ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã€æ–°ãŸãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®å½¢ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
                </p>
                <div class="h-px bg-white/10 mb-8"></div>
                <p class="text-gray-500 text-xs">&copy; 2024 Innovative DAO Creative Trial. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox"
        class="fixed inset-0 bg-black/95 z-[110] hidden flex items-center justify-center p-4 cursor-pointer">
        <button class="absolute top-6 right-6 text-white text-4xl hover:scale-110 transition-transform">&times;</button>
        <div class="max-w-5xl w-full flex flex-col items-center">
            <img id="lightbox-img" src="" alt="" class="max-h-[85vh] object-contain rounded-sm shadow-2xl">
            <p id="lightbox-caption" class="text-white mt-6 text-sm font-light text-center tracking-wide"></p>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none z-[120] text-sm">
        ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const CONFIG = {
            folderId: "1-NfQibqzfAQzOTBWF3AkBQ4fyfPF2gdZ",
            apiKey: "AIzaSyDc7ugWSJWM_f0J6bg25soRj9AWmvSt7tk", // Firebase API Keyã‚’åˆ©ç”¨
            adminEmails: [
                "support@happy-planet-earth.com"
            ]
        };

        // TODO: Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ« [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š] > [ãƒã‚¤ã‚¢ãƒ—ãƒª] ã‹ã‚‰å–å¾—ã—ãŸè¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        const firebaseConfig = {
            apiKey: "AIzaSyDc7ugWSJWM_f0J6bg25soRj9AWmvSt7tk",
            authDomain: "hpep-event.firebaseapp.com",
            projectId: "hpep-event",
            storageBucket: "hpep-event.firebasestorage.app",
            messagingSenderId: "664747295572",
            appId: "1:664747295572:web:86c3d4b7b176213af5bec1",
            measurementId: "G-8M1HBWQGNE"
        };

        // const firebaseConfig = JSON.parse(__firebase_config); // å…ƒã®ã‚³ãƒ¼ãƒ‰
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const authOverlay = document.getElementById('auth-overlay');
        const mainContent = document.getElementById('main-content');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const authErrorContainer = document.getElementById('auth-error-container');
        const authErrorText = document.getElementById('auth-error-text');
        const unauthorizedDomainGuide = document.getElementById('unauthorized-domain-guide');

        const adminActions = document.getElementById('admin-actions');
        const settingsPanel = document.getElementById('settings-panel');
        const userRoleBadge = document.getElementById('user-role-badge');
        const galleryGrid = document.getElementById('gallery-grid');
        const statusMessage = document.getElementById('status-message');
        const statusText = document.getElementById('status-text');
        const loadingStatus = document.getElementById('loading-status');
        const folderIdInput = document.getElementById('folder-id-input');
        const apiKeyInput = document.getElementById('api-key-input');

        folderIdInput.value = CONFIG.folderId;
        apiKeyInput.value = CONFIG.apiKey;

        loginButton.onclick = async () => {
            authErrorContainer.classList.add('hidden');
            unauthorizedDomainGuide.classList.add('hidden');
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                authErrorContainer.classList.remove('hidden');
                authErrorText.innerText = error.message;

                // ç‰¹å®šã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã®å ´åˆã«ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
                if (error.code === 'auth/unauthorized-domain') {
                    unauthorizedDomainGuide.classList.remove('hidden');
                }
            }
        };

        logoutButton.onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const isAdmin = CONFIG.adminEmails.includes(user.email);
                authOverlay.style.display = 'none';
                mainContent.style.display = 'block';
                userRoleBadge.innerText = isAdmin ? `ADMIN: ${user.email}` : `USER: ${user.email}`;
                if (isAdmin) adminActions.classList.remove('hidden');
                fetchPhotosFromDrive(folderIdInput.value.trim() || CONFIG.folderId);
            } else {
                authOverlay.style.display = 'flex';
                mainContent.style.display = 'none';
                galleryGrid.innerHTML = '';
            }
        });

        document.getElementById('settings-toggle').addEventListener('click', () => {
            console.log("Settings toggled");
            settingsPanel.classList.toggle('hidden');
        });

        async function fetchPhotosFromDrive(folderId) {
            const activeKey = apiKeyInput.value.trim() || CONFIG.apiKey;
            if (!activeKey) {
                showStatus("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "âš ï¸");
                return;
            }
            loadingStatus.classList.remove('hidden');
            galleryGrid.innerHTML = '';
            statusMessage.classList.add('hidden');
            try {
                const query = encodeURIComponent(`'${folderId}' in parents and mimeType contains 'image/' and trashed = false`);
                const url = `https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name)&key=${activeKey}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("APIã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼");
                const data = await response.json();
                if (data.files && data.files.length > 0) {
                    renderGallery(data.files);
                } else {
                    showStatus("ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚", "â“");
                }
            } catch (error) {
                showStatus("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "âŒ");
            } finally {
                loadingStatus.classList.add('hidden');
            }
        }

        function showStatus(text, icon = "ğŸ“·") {
            statusMessage.classList.remove('hidden');
            statusText.innerText = text;
            document.getElementById('status-icon').innerText = icon;
        }

        function renderGallery(files) {
            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'gallery-item relative aspect-square bg-white rounded-xl overflow-hidden cursor-pointer shadow-sm hover:shadow-md transition-all hover:-translate-y-0.5 border border-slate-100';
                const displayUrl = `https://lh3.googleusercontent.com/u/0/d/${file.id}`;
                item.innerHTML = `
                    <img src="${displayUrl}" alt="${file.name}" class="w-full h-full object-cover opacity-0 transition-opacity duration-500" 
                        onload="this.classList.add('opacity-100')" loading="lazy">
                    <div class="overlay absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 transition-opacity flex flex-col justify-end p-3">
                        <p class="text-white font-medium truncate text-[10px] tracking-tight">${file.name}</p>
                    </div>`;
                item.onclick = () => {
                    document.getElementById('lightbox-img').src = displayUrl;
                    document.getElementById('lightbox-caption').innerText = file.name;
                    document.getElementById('lightbox').classList.remove('hidden');
                };
                galleryGrid.appendChild(item);
            });
        }

        document.getElementById('sync-button').onclick = () => fetchPhotosFromDrive(folderIdInput.value.trim());
        document.getElementById('lightbox').onclick = () => document.getElementById('lightbox').classList.add('hidden');
        document.getElementById('copy-link').onclick = () => {
            const dummy = document.createElement('input');
            document.body.appendChild(dummy);
            dummy.value = window.location.href;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            const toast = document.getElementById('toast');
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2000);
        };
    </script>
</body>

</html>